<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ESP32 Robot Controller</title>
  
  <script src="/nipplejs.min.js"></script>

  <style>
    /* 2スペースインデントに統一 */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      min-height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: #333;
      color: #fff;
    }
    
    body { 
      display: flex; 
      flex-direction: column; 
      
      /* ▼▼▼ ② 左右マージン(パディング)を追加 ▼▼▼ */
      padding-left: 50px;
      padding-right: 50px;
      box-sizing: border-box; /* パディングを幅に含める */
      /* --- ▲▲▲ --- */

      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    header {
      padding: 10px 20px;
      background-color: #222;
      text-align: center;
      flex-shrink: 0;
      touch-action: auto; 
    }
    
    h1 { margin: 0; font-size: 1.2em; }
    #status { font-size: 0.9em; color: #ffc107; }
    
    #led-toggle-area {
      padding: 10px;
      background-color: #2a2a2a;
      flex-shrink: 0;
      text-align: center;
      display: flex;
      justify-content: center;
      gap: 10px;
      touch-action: auto; 
    }

    .btn-led {
      background-color: #555;
      border: none;
      border-radius: 8px;
      padding: 10px 15px;
      color: white;
      font-weight: bold;
      font-size: 0.9em;
    }
    .btn-led:active {
      background-color: #777;
    }

    main#control-area {
      display: flex;
      flex-direction: column;
      padding: 10px 0; /* 左右パディングを削除 (body側で管理) */
      gap: 10px;
      box-sizing: border-box;
    }

    .zone {
      position: relative;
      background-color: #444;
      border-radius: 15px;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 5px;
      box-sizing: border-box;
      touch-action: none;
    }
    
    /* ▼▼▼ ① スティックラベルのCSSを追加 ▼▼▼ */
    .zone-label {
      position: absolute;
      top: 8px;
      left: 12px;
      font-size: 1.0em;
      font-weight: bold;
      color: rgba(255, 255, 255, 0.3); /* 半透明の白 */
      z-index: 1; /* スティックの手前に来るように */
      pointer-events: none; /* クリック操作を無効化 */
      user-select: none;
    }
    /* --- ▲▲▲ --- */

    #telemetry-area {
      min-height: 100px;
      border: 1px solid #666;
      font-size: 0.9em;
      text-align: center;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      touch-action: auto;
    }
    .tele-servo-group {
      text-align: center;
      font-size: 0.9em;
      padding: 5px 0;
    }
    .tele-servo-group .label { font-weight: bold; color: #ccc; }
    .tele-servo-group .current {
      font-size: 1.4em;
      color: #4CAF50;
      font-weight: bold;
      margin: 2px 0;
    }
    .tele-servo-group .limit { font-size: 0.8em; color: #999; }

    #servo-area {
      min-height: 150px;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: 10px;
      width: 100%;
    }
    
    #omni-area {
      min-height: 200px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      width: 100%;
    }
    
    #limit-settings-area {
      padding: 10px 20px;
      background-color: #222;
      flex-shrink: 0;
      text-align: center;
      font-size: 0.8em;
      touch-action: auto; 
    }
    #limit-settings-area input[type="number"] {
      width: 50px;
      -moz-appearance: textfield;
    }
    #limit-settings-area input::-webkit-outer-spin-button,
    #limit-settings-area input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    #limit-settings-area button {
      margin: 2px 5px;
      padding: 4px 8px;
    }
    .servo-limit-group {
      margin: 2px 0;
    }
  </style>
</head>

<body>
  <header>
    <h1>Robot Controller</h1>
    <div id="status">Connecting to WebSocket...</div>
  </header>

  <div id="led-toggle-area">
    <button id="btn-led-0" class="btn-led">Toggle LED 0</button>
    <button id="btn-led-1" class="btn-led">Toggle LED 1</button>
    <button id="btn-led-2" class="btn-led">Toggle LED 2</button>
  </div>
  
  <main id="control-area">
    
    <div id="telemetry-area" class="zone">
      <div class="tele-servo-group">
        <div class="label">S0</div>
        <div class="limit">Max: <span id="tele-s0-max">180.0</span></div>
        <div class="current"><span id="tele-s0-ang">90.0</span></div>
        <div class="limit">Min: <span id="tele-s0-min">0.0</span></div>
      </div>
      <div class="tele-servo-group">
        <div class="label">S1</div>
        <div class="limit">Max: <span id="tele-s1-max">180.0</span></div>
        <div class="current"><span id="tele-s1-ang">90.0</span></div>
        <div class="limit">Min: <span id="tele-s1-min">0.0</span></div>
      </div>
      <div class="tele-servo-group">
        <div class="label">S2</div>
        <div class="limit">Max: <span id="tele-s2-max">180.0</span></div>
        <div class="current"><span id="tele-s2-ang">90.0</span></div>
        <div class="limit">Min: <span id="tele-s2-min">0.0</span></div>
      </div>
      <div class="tele-servo-group">
        <div class="label">S3</div>
        <div class="limit">Max: <span id="tele-s3-max">180.0</span></div>
        <div class="current"><span id="tele-s3-ang">90.0</span></div>
        <div class="limit">Min: <span id="tele-s3-min">0.0</span></div>
      </div>
    </div>

    <div id="servo-area">
      <div id="slider-s1-zone" class="zone">
        <div class="zone-label">S1</div>
      </div>
      <div id="slider-s2-zone" class="zone">
        <div class="zone-label">S2</div>
      </div>
      <div id="slider-s3-zone" class="zone">
        <div class="zone-label">S3</div>
      </div>
      <div id="slider-s4-zone" class="zone">
        <div class="zone-label">S4</div>
      </div>
    </div>

    <div id="omni-area">
      <div id="joy-move-zone" class="zone">
        <div class="zone-label">Move</div>
      </div>
      <div id="slider-omega-zone" class="zone">
        <div class="zone-label">Rotate</div>
      </div>
    </div>
    </main>
  
  <div id="limit-settings-area">
    <div class="servo-limit-group">
      S0: Min <input type="number" id="s0-min" value="0"> Max <input type="number" id="s0-max" value="180">
      S1: Min <input type="number" id="s1-min" value="0"> Max <input type="number" id="s1-max" value="180">
    </div>
    <div class="servo-limit-group">
      S2: Min <input type="number" id="s2-min" value="0"> Max <input type="number" id="s2-max" value="180">
      S3: Min <input type="number" id="s3-min" value="0"> Max <input type="number" id="s3-max" value="180">
      <button id="btn-apply-limits">Apply Limits</button>
    </div>
  </div>
  
  <script>
    // --- 1. グローバル設定 (変更なし) ---
    const SEND_INTERVAL = 50;
    const statusEl = document.getElementById('status');
    let controlState = { 
      vx: 0.0, vy: 0.0, omega: 0.0, 
      s1_vel: 0.0, s2_vel: 0.0, s3_vel: 0.0, s4_vel: 0.0
    };

    // --- 2. WebSocketの初期化 (変更なし) ---
    const gateway = `ws://${window.location.hostname}/ws`;
    let websocket;
    function initWebSocket() {
      if (window.location.protocol === "file:") {
        statusEl.innerText = "Local Test Mode (WebSocket Disabled)";
        statusEl.style.color = "#ffc107";
        return;
      }
      websocket = new WebSocket(gateway);
      websocket.onopen = () => { statusEl.innerText = "Connected"; statusEl.style.color = "#4CAF50"; };
      websocket.onclose = () => { statusEl.innerText = "Disconnected. Retrying..."; statusEl.style.color = "#f44336"; setTimeout(initWebSocket, 2000); };
      websocket.onerror = (error) => { statusEl.innerText = "WebSocket Error"; statusEl.style.color = "#f44336"; console.error("WebSocket Error: ", error); };
      websocket.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.telemetry) {
            const tele = data.telemetry;
            document.getElementById('tele-s0-ang').innerText = tele.s0.ang.toFixed(1);
            document.getElementById('tele-s0-min').innerText = tele.s0.min.toFixed(1);
            document.getElementById('tele-s0-max').innerText = tele.s0.max.toFixed(1);
            document.getElementById('tele-s1-ang').innerText = tele.s1.ang.toFixed(1);
            document.getElementById('tele-s1-min').innerText = tele.s1.min.toFixed(1);
            document.getElementById('tele-s1-max').innerText = tele.s1.max.toFixed(1);
            document.getElementById('tele-s2-ang').innerText = tele.s2.ang.toFixed(1);
            document.getElementById('tele-s2-min').innerText = tele.s2.min.toFixed(1);
            document.getElementById('tele-s2-max').innerText = tele.s2.max.toFixed(1);
            document.getElementById('tele-s3-ang').innerText = tele.s3.ang.toFixed(1);
            document.getElementById('tele-s3-min').innerText = tele.s3.min.toFixed(1);
            document.getElementById('tele-s3-max').innerText = tele.s3.max.toFixed(1);
          }
        } catch (e) { console.error("Failed to parse telemetry JSON:", e); }
      };
    }
    initWebSocket();

    // --- iPadOS/iOS ズーム/長押し対策 (変更なし) ---
    document.addEventListener('dblclick', (e) => { e.preventDefault(); }, { passive: false });
    document.addEventListener('contextmenu', (e) => { e.preventDefault(); }, { passive: false });

    // --- 3. 設定ボタンのイベントリスナー (変更なし) ---
    function setupButtonListeners() {
      document.getElementById('btn-led-0').onclick = () => { websocket.send(JSON.stringify({ "toggle_led": 0 })); };
      document.getElementById('btn-led-1').onclick = () => { websocket.send(JSON.stringify({ "toggle_led": 1 })); };
      document.getElementById('btn-led-2').onclick = () => { websocket.send(JSON.stringify({ "toggle_led": 2 })); };
      document.getElementById('btn-apply-limits').onclick = () => {
        const limits = [
          { servo: 0, min: parseInt(document.getElementById('s0-min').value), max: parseInt(document.getElementById('s0-max').value) },
          { servo: 1, min: parseInt(document.getElementById('s1-min').value), max: parseInt(document.getElementById('s1-max').value) },
          { servo: 2, min: parseInt(document.getElementById('s2-min').value), max: parseInt(document.getElementById('s2-max').value) },
          { servo: 3, min: parseInt(document.getElementById('s3-min').value), max: parseInt(document.getElementById('s3-max').value) }
        ];
        for (const limit of limits) {
          if (websocket && websocket.readyState === WebSocket.OPEN) {
            websocket.send(JSON.stringify({ "set_limit": limit }));
          }
        }
        alert("Servo limits applied!");
      };
    }
    
    // --- 4. コントローラー (nipplejs) の初期化 ---
    window.onload = function() {
      setupButtonListeners();
      setTimeout(() => {
        
        // --- ▼ オムニエリア ▼ ---
        const joyMoveZone = document.getElementById('joy-move-zone');
        const joyMove = nipplejs.create({
            zone: joyMoveZone,
            mode: 'static',
            position: { left: '50%', top: '50%' },
            color: 'cyan',
            size: Math.min(joyMoveZone.clientWidth, joyMoveZone.clientHeight) * 0.5 /* ★ 0.8 -> 0.75 */
        });
        joyMove.on('move', (evt, data) => { controlState.vx = data.vector.x; controlState.vy = data.vector.y; });
        joyMove.on('end', () => { controlState.vx = 0.0; controlState.vy = 0.0; });
        
        const sliderOmegaZone = document.getElementById('slider-omega-zone');
        const sliderOmega = nipplejs.create({
            zone: sliderOmegaZone,
            mode: 'static',
            position: { left: '50%', top: '50%' },
            color: 'lime',
            lockX: true, // 水平
            size: Math.min(sliderOmegaZone.clientWidth, sliderOmegaZone.clientHeight) * 0.5 /* ★ 0.8 -> 0.75 */
        });
        sliderOmega.on('move', (evt, data) => { controlState.omega = -data.vector.x; });
        sliderOmega.on('end', () => { controlState.omega = 0.0; });
        
        // --- ▼ サーボエリア ▼ ---
        const sliderS1Zone = document.getElementById('slider-s1-zone');
        const sliderS1 = nipplejs.create({
            zone: sliderS1Zone,
            mode: 'static',
            position: { left: '50%', top: '55%' }, /* ★ 中央より少し下に配置 */
            color: 'magenta',
            lockY: true, // 垂直
            size: Math.min(sliderS1Zone.clientWidth, sliderS1Zone.clientHeight) * 0.5 /* ★ 0.8 -> 0.75 */
        });
        sliderS1.on('move', (evt, data) => { controlState.s1_vel = data.vector.y; });
        sliderS1.on('end', () => { controlState.s1_vel = 0.0; });

        const sliderS2Zone = document.getElementById('slider-s2-zone');
        const sliderS2 = nipplejs.create({
            zone: sliderS2Zone,
            mode: 'static',
            position: { left: '50%', top: '55%' }, /* ★ 中央より少し下に配置 */
            color: 'yellow',
            lockY: true, // 垂直
            size: Math.min(sliderS2Zone.clientWidth, sliderS2Zone.clientHeight) * 0.5 /* ★ 0.8 -> 0.75 */
        });
        sliderS2.on('move', (evt, data) => { controlState.s2_vel = data.vector.y; });
        sliderS2.on('end', () => { controlState.s2_vel = 0.0; });

        const sliderS3Zone = document.getElementById('slider-s3-zone');
        const sliderS3 = nipplejs.create({
            zone: sliderS3Zone,
            mode: 'static',
            position: { left: '50%', top: '55%' }, /* ★ 中央より少し下に配置 */
            color: 'orange',
            lockY: true, // 垂直
            size: Math.min(sliderS3Zone.clientWidth, sliderS3Zone.clientHeight) * 0.5 /* ★ 0.8 -> 0.75 */
        });
        sliderS3.on('move', (evt, data) => { controlState.s3_vel = data.vector.y; });
        sliderS3.on('end', () => { controlState.s3_vel = 0.0; });

        const sliderS4Zone = document.getElementById('slider-s4-zone');
        const sliderS4 = nipplejs.create({
            zone: sliderS4Zone,
            mode: 'static',
            position: { left: '50%', top: '55%' }, /* ★ 中央より少し下に配置 */
            color: 'red',
            lockY: true, // 垂直
            size: Math.min(sliderS4Zone.clientWidth, sliderS4Zone.clientHeight) * 0.5 /* ★ 0.8 -> 0.75 */
        });
        sliderS4.on('move', (evt, data) => { controlState.s4_vel = data.vector.y; });
        sliderS4.on('end', () => { controlState.s4_vel = 0.0; });

      }, 100); 
    };
    
    // --- 5. データ送信ループ (変更なし) ---
    setInterval(() => {
      if (websocket && websocket.readyState === WebSocket.OPEN) {
        websocket.send(JSON.stringify(controlState));
      }
    }, SEND_INTERVAL);

  </script>
</body>
</html>